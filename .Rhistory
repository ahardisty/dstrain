xref.predict_year,
xref.day_of_week,
xref.week_of_year,
xref.quarter_of_year,
xref.day_of_year,
xref.day_of_year_shift,
tou.rt_sched_cd,
tou.tou_cd,
usg.usg_amt,
DATE_PART('hour', usg.elec_intvl_end_dttm) AS usg_hr"
)
agg_head
agg_head <-  c(
""
)
agg_head
join_head <- c(
"(SELECT cust.model_id, cust.group_id,
cust.uniq_sa_id,
cust.deriv_baseline_terr_cd,
cust.opr_area_cd,
xref.calendar_date,
xref.month_of_year,
xref.day_of_month,
xref.train_year,
xref.predict_year,
xref.day_of_week,
xref.week_of_year,
xref.quarter_of_year,
xref.day_of_year,
xref.day_of_year_shift,
tou.rt_sched_cd,
tou.tou_cd,
usg.usg_amt,
DATE_PART('hour', usg.elec_intvl_end_dttm) AS usg_hr"
)
obj_in
obj_in
obj_in <- stringr::str_to_lower(paste0("`",paste("usg",usg_yr, tou, terr_cd, sep = "_"),"`"))
obj_in
obj_in <- stringr::str_to_lower(paste0("`",paste("usg",usg_yr, tou, terr_cd, sep = "_"),"`"))
obj_in
obj_in <- stringr::str_to_lower(paste0("`",paste("model_population_",tou, terr_cd, sep = "_"),"`"))
obj_in
obj_in <- stringr::str_to_lower(paste0("`",paste("model_population",tou, terr_cd, sep = "_"),"`"))
obj_in
obj_out <- paste("usg",usg_yr, tou, terr_cd, sep = "_")
obj_out
obj_out <- stringr::str_to_lower(paste("usg",tou, terr_cd, sep = "_")))
obj_out <- stringr::str_to_lower(paste("usg",tou, terr_cd, sep = "_"))
obj_out
obj_out <- paste("usg",usg_yr, tou, sep = "_")
obj_out
obj_out <- stringr::str_to_lower(paste("usg",usg_yr, tou, terr_cd, sep = "_"))
obj_out
out_path <- paste0('data/sql/',obj_out,".sql")
out_path
create_head
create_head <- paste(
paste0("DROP TABLE IF EXISTS `rda`.`rdadata`.",obj_in),
paste0("CREATE TABLE `rda`.`rdadata`.",obj_in), sep = ';\n')
create_head
obj_in <- stringr::str_to_lower(paste0("`",paste("usg",tou, terr_cd, sep = "_"),"`"))
obj_in
obj_in <- stringr::str_to_lower(paste0("`",paste("usg",usg_yr, tou, terr_cd, sep = "_"),"`"))
obj_in
paste0("DROP TABLE IF EXISTS `rda`.`rdadata`.",obj_in)
obj_in
pop_in <- stringr::str_to_lower(paste0("`",paste("model_population",usg_yr, tou, terr_cd, sep = "_"),"`"))
pop_in
stringr::str_to_lower(paste0("`",paste("model_population", terr_cd, sep = "_"),"`"))
pop_in <- stringr::str_to_lower(paste0("`",paste("model_population", terr_cd, sep = "_"),"`"))
from_body <- paste("FROM `rda`.`rdadata`.",pop_in)
from_body
from_body <- paste0("FROM `rda`.`rdadata`.",pop_in," AS cust")
from_body
list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body, agg_body)
from_body <- paste0("FROM `rda`.`rdadata`.",pop_in," AS cust")
join_body <- c(
"INNER JOIN `rda`.`rdatables`.`elec_intvl_usg_all` AS usg
ON cust.uniq_sa_id = usg.uniq_sa_id
INNER JOIN  `rda`.`rdadata`.`time_shift_xref` AS xref
ON usg.usg_dt = xref.calendar_date"
)
where <- paste("")
tou_body <- c(
"JOIN  `rda`.`rdadata`.`tou_lookup_2017_hetoua` AS tou
ON usg.usg_dt = tou.calendar_date
AND usg.elec_intvl_end_dttm BETWEEN tou.tou_data_from_dttm AND tou.tou_data_to_dttm"
)
agg_body <- c(
"")
usg_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body, agg_body)
create_head <- paste(
paste0("DROP TABLE IF EXISTS `rda`.`rdadata`.",obj_in),
paste0("CREATE TABLE `rda`.`rdadata`.",obj_in), sep = ';\n')
part_body <- c(
"(calendar_date,
month_of_year,
day_of_month,
train_year,
predict_year,
day_of_week,
week_of_year,
quarter_of_year,
day_of_year,
day_of_year_shift,
wea_data_typ_id,
wea_data_typ_cd,
baseline_terr_cd,
opr_area_cd,
usg_hr,
rt_sched_cd,
tou_cd, meas_val)"
)
usg_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body, agg_body)
part_str <-  c(
"PARITION BY (day_of_year)")
part_str
agg_head <-  c(
""
)
join_head <- c(
"(SELECT cust.model_id, cust.group_id,
cust.uniq_sa_id,
cust.deriv_baseline_terr_cd,
cust.opr_area_cd,
xref.calendar_date,
xref.month_of_year,
xref.day_of_month,
xref.train_year,
xref.predict_year,
xref.day_of_week,
xref.week_of_year,
xref.quarter_of_year,
xref.day_of_year,
xref.day_of_year_shift,
tou.rt_sched_cd,
tou.tou_cd,
usg.usg_amt,
DATE_PART('hour', usg.elec_intvl_end_dttm) AS usg_hr"
)
from_body <- paste0("FROM `rda`.`rdadata`.",pop_in," AS cust")
join_body <- c(
"INNER JOIN `rda`.`rdatables`.`elec_intvl_usg_all` AS usg
ON cust.uniq_sa_id = usg.uniq_sa_id
INNER JOIN  `rda`.`rdadata`.`time_shift_xref` AS xref
ON usg.usg_dt = xref.calendar_date"
)
where <- paste("")
tou_body <- c(
"JOIN  `rda`.`rdadata`.`tou_lookup_2017_hetoua` AS tou
ON usg.usg_dt = tou.calendar_date
AND usg.elec_intvl_end_dttm BETWEEN tou.tou_data_from_dttm AND tou.tou_data_to_dttm"
)
agg_body <- c(
"")
usg_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body, agg_body)
usg_tou_query
usg_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body, agg_body)
readr::write_lines(usg_tou_query, path  = out_path, append = FALSE)
source('~/Documents/dstrain/R/reframe_usg_sql.R', echo=TRUE)
reframe_usg_sql()
source('~/Documents/dstrain/R/reframe_usg_sql.R', echo=TRUE)
reframe_usg_sql(terr_cd = "B")
terr_cd <- A:D
terr_cd <- LETTERS[1:3]
terr_cd
terr_cd %>% reframe_usg_sql()
terr_cd %>% map(reframe_usg_sql())
terr_cd %>% purrr::map(reframe_usg_sql())
terr_cd %>% purrr::walk(reframe_usg_sql)
obj_out
usg_yr = 2017
tou = "hetoua"
usg_id = "D"
where <- paste("where usg_type =",usg_id)
where
obj_in <- stringr::str_to_lower(paste0("`",paste("usg",usg_yr, tou, terr_cd, sep = "_"),"`"))
terr_cd = 'X'
obj_in <- stringr::str_to_lower(paste0("`",paste("usg",usg_yr, tou, terr_cd, sep = "_"),"`"))
obj_in
obj_out <- stringr::str_to_lower(paste("usg",usg_yr, tou, terr_cd, sep = "_"))
obj_out
pop_in <- stringr::str_to_lower(paste0("`",paste("model_population", terr_cd, sep = "_"),"`"))
out_path <- paste0('data/sql/',obj_out,".sql")
out_path
create_head <- paste(
paste0("DROP TABLE IF EXISTS `rda`.`rdadata`.",obj_in),
paste0("CREATE TABLE `rda`.`rdadata`.",obj_in), sep = ';\n')
part_body <- c(
"(calendar_date,
month_of_year,
day_of_month,
train_year,
predict_year,
day_of_week,
week_of_year,
quarter_of_year,
day_of_year,
day_of_year_shift,
wea_data_typ_id,
wea_data_typ_cd,
baseline_terr_cd,
opr_area_cd,
usg_hr,
rt_sched_cd,
tou_cd, usg_amt)"
)
part_str <-  c(
"PARITION BY (day_of_year)")
agg_head <-  c(
""
)
join_head <- c(
"(SELECT cust.model_id, cust.group_id,
cust.uniq_sa_id,
cust.deriv_baseline_terr_cd,
cust.opr_area_cd,
xref.calendar_date,
xref.month_of_year,
xref.day_of_month,
xref.train_year,
xref.predict_year,
xref.day_of_week,
xref.week_of_year,
xref.quarter_of_year,
xref.day_of_year,
xref.day_of_year_shift,
tou.rt_sched_cd,
tou.tou_cd,
usg.usg_amt,
DATE_PART('hour', usg.elec_intvl_end_dttm) AS usg_hr"
)
from_body <- paste0("FROM `rda`.`rdadata`.",pop_in," AS cust")
join_body <- c(
"INNER JOIN `rda`.`rdatables`.`elec_intvl_usg_all` AS usg
ON cust.uniq_sa_id = usg.uniq_sa_id
INNER JOIN  `rda`.`rdadata`.`time_shift_xref` AS xref
ON usg.usg_dt = xref.calendar_date"
)
where <- paste("where usg_id =",usg_id)
tou_body <- c(
"JOIN  `rda`.`rdadata`.`tou_lookup_2017_hetoua` AS tou
ON usg.usg_dt = tou.calendar_date
AND usg.elec_intvl_end_dttm BETWEEN tou.tou_data_from_dttm AND tou.tou_data_to_dttm"
)
agg_body <- c(
"")
usg_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body, agg_body)
usg_tou_query
out_path
reframe_usg_sql <- function(usg_yr = 2017, tou = "hetoua", usg_id = "D", terr_cd = 'X', train = TRUE)  {
obj_in <- stringr::str_to_lower(paste0("`",paste("usg",usg_yr, tou, terr_cd, sep = "_"),"`"))
obj_out <- stringr::str_to_lower(paste("usg",usg_yr, tou, terr_cd, sep = "_"))
pop_in <- stringr::str_to_lower(paste0("`",paste("model_population", terr_cd, sep = "_"),"`"))
out_path <- paste0('data/sql/',obj_out,".sql")
create_head <- paste(
paste0("DROP TABLE IF EXISTS `rda`.`rdadata`.",obj_in),
paste0("CREATE TABLE `rda`.`rdadata`.",obj_in), sep = ';\n')
part_body <- c(
"(calendar_date,
month_of_year,
day_of_month,
train_year,
predict_year,
day_of_week,
week_of_year,
quarter_of_year,
day_of_year,
day_of_year_shift,
wea_data_typ_id,
wea_data_typ_cd,
baseline_terr_cd,
opr_area_cd,
usg_hr,
rt_sched_cd,
tou_cd, usg_amt)"
)
part_str <-  c(
"PARITION BY (day_of_year)")
agg_head <-  c(
""
)
join_head <- c(
"(SELECT cust.model_id, cust.group_id,
cust.uniq_sa_id,
cust.deriv_baseline_terr_cd,
cust.opr_area_cd,
xref.calendar_date,
xref.month_of_year,
xref.day_of_month,
xref.train_year,
xref.predict_year,
xref.day_of_week,
xref.week_of_year,
xref.quarter_of_year,
xref.day_of_year,
xref.day_of_year_shift,
tou.rt_sched_cd,
tou.tou_cd,
usg.usg_amt,
DATE_PART('hour', usg.elec_intvl_end_dttm) AS usg_hr"
)
from_body <- paste0("FROM `rda`.`rdadata`.",pop_in," AS cust")
join_body <- c(
"INNER JOIN `rda`.`rdatables`.`elec_intvl_usg_all` AS usg
ON cust.uniq_sa_id = usg.uniq_sa_id
INNER JOIN  `rda`.`rdadata`.`time_shift_xref` AS xref
ON usg.usg_dt = xref.calendar_date"
)
where <- paste("where usg_id =",usg_id)
tou_body <- c(
"JOIN  `rda`.`rdadata`.`tou_lookup_2017_hetoua` AS tou
ON usg.usg_dt = tou.calendar_date
AND usg.elec_intvl_end_dttm BETWEEN tou.tou_data_from_dttm AND tou.tou_data_to_dttm"
)
agg_body <- c(
"")
usg_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body, agg_body)
readr::write_lines(usg_tou_query, path  = out_path, append = FALSE)
print("check output dir...")
}
reframe_usg_sql(terr_cd = "B")
terr_cd <- LETTERS[1:3]
terr_cd %>% purrr::walk(reframe_usg_sql)
out_path
reframe_usg_sql <- function(terr_cd, usg_yr = 2017, tou = "hetoua", usg_id = "D", train = TRUE)  {
obj_in <- stringr::str_to_lower(paste0("`",paste("usg",usg_yr, tou, terr_cd, sep = "_"),"`"))
obj_out <- stringr::str_to_lower(paste("usg",usg_yr, tou, terr_cd, sep = "_"))
pop_in <- stringr::str_to_lower(paste0("`",paste("model_population", terr_cd, sep = "_"),"`"))
out_path <- paste0('data/sql/',obj_out,".sql")
create_head <- paste(
paste0("DROP TABLE IF EXISTS `rda`.`rdadata`.",obj_in),
paste0("CREATE TABLE `rda`.`rdadata`.",obj_in), sep = ';\n')
part_body <- c(
"(calendar_date,
month_of_year,
day_of_month,
train_year,
predict_year,
day_of_week,
week_of_year,
quarter_of_year,
day_of_year,
day_of_year_shift,
wea_data_typ_id,
wea_data_typ_cd,
baseline_terr_cd,
opr_area_cd,
usg_hr,
rt_sched_cd,
tou_cd, usg_amt)"
)
part_str <-  c(
"PARITION BY (day_of_year)")
agg_head <-  c(
""
)
join_head <- c(
"(SELECT cust.model_id, cust.group_id,
cust.uniq_sa_id,
cust.deriv_baseline_terr_cd,
cust.opr_area_cd,
xref.calendar_date,
xref.month_of_year,
xref.day_of_month,
xref.train_year,
xref.predict_year,
xref.day_of_week,
xref.week_of_year,
xref.quarter_of_year,
xref.day_of_year,
xref.day_of_year_shift,
tou.rt_sched_cd,
tou.tou_cd,
usg.usg_amt,
DATE_PART('hour', usg.elec_intvl_end_dttm) AS usg_hr"
)
from_body <- paste0("FROM `rda`.`rdadata`.",pop_in," AS cust")
join_body <- c(
"INNER JOIN `rda`.`rdatables`.`elec_intvl_usg_all` AS usg
ON cust.uniq_sa_id = usg.uniq_sa_id
INNER JOIN  `rda`.`rdadata`.`time_shift_xref` AS xref
ON usg.usg_dt = xref.calendar_date"
)
where <- paste("where usg_id =",usg_id)
tou_body <- c(
"JOIN  `rda`.`rdadata`.`tou_lookup_2017_hetoua` AS tou
ON usg.usg_dt = tou.calendar_date
AND usg.elec_intvl_end_dttm BETWEEN tou.tou_data_from_dttm AND tou.tou_data_to_dttm"
)
agg_body <- c(
"")
usg_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body, agg_body)
readr::write_lines(usg_tou_query, path  = out_path, append = FALSE)
print("check output dir...")
}
reframe_usg_sql(terr_cd = "B")
reframe_usg_sql(terr_cd = "B")
terr_cd %>% purrr::walk(reframe_usg_sql)
usg_tou_query
usg_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body,
join_body, tou_body, where, agg_body)
usg_tou_query
usg_tou_query <- list("head" = create_head,part_body, part_str,agg_head, join_head, from_body,
join_body, tou_body, where, agg_body)
usg_tou_query
usg_tou_query <- list(head = create_head,part_body, part_str,agg_head, join_head, from_body,
join_body, tou_body, where, agg_body)
usg_tou_query
agg_head
usg_tou_query <- list(head = create_head, col_nms = part_body, part_by = part_str,
agg_head = agg_head, join_head = join_head, from = from_body,
join_body = join_body, tou_body = tou_body, where = where, agg_body = agg_body)
usg_tou_query
usg_tou_query <- list(head = create_head, partition = c(part_body, part_str),
agg_head = agg_head, join_head = join_head, from = from_body,
join_body = join_body, tou_body = tou_body, where = where, agg_body = agg_body)
usg_tou_query
list(head = create_head, partition = c(part_body, part_str),
select = c(agg_head, join_head), from = from_body,
join_body = join_body, tou_body = tou_body, where = where, agg_body = agg_body)
usg_tou_query <- list(head = create_head, partition = c(part_body, part_str),
select = c(agg_head, join_head), from = from_body,
join = c(join_body, tou_body), where = where, agg_body = agg_body)
usg_tou_query
terr_cd <- LETTERS[1:3]
terr_cd %>% purrr::walk(reframe_usg_sql)
source('~/Documents/dstrain/R/reframe_usg_sql.R', echo=TRUE)
source('~/Documents/dstrain/R/reframe_usg_sql.R', echo=TRUE)
source('~/Documents/dstrain/R/reframe_usg_sql.R', echo=TRUE)
reframe_usg_sql <- function(terr_cd, usg_yr = 2017, tou = "hetoua", usg_id = "D", train = TRUE)  {
obj_in <- stringr::str_to_lower(paste0("`",paste("usg",usg_yr, tou, terr_cd, sep = "_"),"`"))
obj_out <- stringr::str_to_lower(paste("usg",usg_yr, tou, terr_cd, sep = "_"))
pop_in <- stringr::str_to_lower(paste0("`",paste("model_population", terr_cd, sep = "_"),"`"))
out_path <- paste0('data/sql/',obj_out,".sql")
create_head <- paste(
paste0("DROP TABLE IF EXISTS `rda`.`rdadata`.",obj_in),
paste0("CREATE TABLE `rda`.`rdadata`.",obj_in), sep = ';\n')
part_body <- c(
"(calendar_date,
month_of_year,
day_of_month,
train_year,
predict_year,
day_of_week,
week_of_year,
quarter_of_year,
day_of_year,
day_of_year_shift,
wea_data_typ_id,
wea_data_typ_cd,
baseline_terr_cd,
opr_area_cd,
usg_hr,
rt_sched_cd,
tou_cd, usg_amt)"
)
part_str <-  c(
"PARITION BY (day_of_year)")
agg_head <-  c(
""
)
join_head <- c(
"(SELECT cust.model_id, cust.group_id,
cust.uniq_sa_id,
cust.deriv_baseline_terr_cd,
cust.opr_area_cd,
xref.calendar_date,
xref.month_of_year,
xref.day_of_month,
xref.train_year,
xref.predict_year,
xref.day_of_week,
xref.week_of_year,
xref.quarter_of_year,
xref.day_of_year,
xref.day_of_year_shift,
tou.rt_sched_cd,
tou.tou_cd,
usg.usg_amt,
DATE_PART('hour', usg.elec_intvl_end_dttm) AS usg_hr"
)
from_body <- paste0("FROM `rda`.`rdadata`.",pop_in," AS cust")
join_body <- c(
"INNER JOIN `rda`.`rdatables`.`elec_intvl_usg_all` AS usg
ON cust.uniq_sa_id = usg.uniq_sa_id
INNER JOIN `rda`.`rdadata`.`time_shift_xref` AS xref
ON usg.usg_dt = xref.calendar_date"
)
where <- paste("where usg_id =",usg_id)
tou_body <- c(
"JOIN `rda`.`rdadata`.`tou_lookup_2017_hetoua` AS tou
ON usg.usg_dt = tou.calendar_date
AND usg.elec_intvl_end_dttm BETWEEN tou.tou_data_from_dttm AND tou.tou_data_to_dttm"
)
agg_body <- c(
"")
usg_tou_query <- list(head = create_head, partition = c(part_body, part_str),
select = c(agg_head, join_head), from = from_body,
join = c(join_body, tou_body), where = where, agg_body = agg_body)
readr::write_lines(usg_tou_query, path  = out_path, append = FALSE)
print("check output dir...")
}
reframe_usg_sql(terr_cd = "B")
terr_cd <- LETTERS[1:3]
terr_cd %>% purrr::walk(reframe_usg_sql)
source('~/Documents/dstrain/R/reframe_wea_sql.R', echo=TRUE)
source('~/Documents/dstrain/R/reframe_usg_sql.R', echo=TRUE)
reframe_usg_sql("x")
source('~/Documents/dstrain/R/reframe_usg_sql.R', echo=TRUE)
