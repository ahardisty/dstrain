AND wea.wea_dttm BETWEEN tou.tou_data_from_dttm AND tou.tou_data_to_dttm")
tou_body
devtools::load_all(".")
obj_nm <- paste0(
"`",paste("wea",wea_yr, tou, sep = "_"),"`")
obj_nm
wea_yr = 2017
tou = "hetoua"
wea_id = "(1, 22, 23)"
wea_src = "PGE"
train = TRUE
train
wea_src
create_head <- paste(
paste0("DROP TABLE IF EXISTS `rda`.`rdadata`.",obj_nm),
paste0("CREATE TABLE `rda`.`rdadata`.",obj_nm), sep = ';\n')
obj_nm <- paste0(
"`",paste("wea",wea_yr, tou, sep = "_"),"`")
obj_nm
create_head <- paste(
paste0("DROP TABLE IF EXISTS `rda`.`rdadata`.",obj_nm),
paste0("CREATE TABLE `rda`.`rdadata`.",obj_nm), sep = ';\n')
part_body <- c(
"(calendar_date,
month_of_year,
day_of_month,
train_year,
predict_year,
day_of_week,
week_of_year,
quarter_of_year,
day_of_year,
day_of_year_shift,
wea_data_typ_id,
wea_data_typ_cd,
baseline_terr_cd,
opr_area_cd,
wea_hr,
rt_sched_cd,
tou_cd, meas_val)
PARITION BY"
)
part_str <-  c(
"(day_of_year)")
agg_head <-  c(
"AS (SELECT wea.calendar_date,
wea.month_of_year,
wea.day_of_month,
wea.train_year,
wea.predict_year,
wea.day_of_week,
wea.week_of_year,
wea.quarter_of_year,
wea.day_of_year,
wea.day_of_year_shift,
wea.wea_data_typ_id,
wea.wea_data_typ_cd,
wea.baseline_terr_cd,
wea.opr_area_cd,
wea.wea_hr,
tou.rt_sched_cd,
tou.tou_cd,
AVG(wea.meas_val) AS meas_val FROM"
)
join_head <- c(
"(SELECT
xref.calendar_date,
xref.month_of_year,
xref.day_of_month,
xref.train_year,
xref.predict_year,
xref.day_of_week,
xref.week_of_year,
xref.quarter_of_year,
xref.day_of_year,
xref.day_of_year_shift,
wea.wea_data_typ_id,
wea.wea_dt,
wea.wea_dttm,
typ.wea_data_typ_cd,
terr_xref.baseline_terr_cd,
area_xref.opr_area_cd,
DATE_PART('hour', wea.wea_dttm) AS wea_hr,
CAST(wea.meas_val AS FLOAT) meas_val"
)
from_body <- c(
"FROM `rda`.`rdadata`.`time_shift_xref` AS xref"
)
join_body <- c(
"JOIN `rda`.`rdatables`.`weather_data`  AS wea
ON xref.calendar_date = wea.wea_dt
JOIN `rda`.`rdatables`.`weather_station` AS stn
ON wea.wea_stn_cd = stn.wea_stn_cd
JOIN `rda`.`rdatables`.`weather_data_type` AS typ
ON wea.wea_data_typ_id = typ.wea_data_typ_id
INNER JOIN `rda`.`rdatables`.`weather_baseline_terr_xref` AS terr_xref
ON wea.wea_stn_cd = terr_xref.wea_stn_cd
AND xref.month_of_year = terr_xref.mo_id
JOIN `rda`.`rdatables`.`weather_op_area_xref` AS area_xref
ON terr_xref.wea_stn_cd = area_xref.wea_stn_cd"
)
where <- paste(
"WHERE xref.train_year =", wea_yr,
"AND wea.wea_data_typ_id IN", wea_id,
"AND stn.wea_stn_owner =", wea_src)
tou_body <- c(
"JOIN `rda`.`rdadata`.`tou_lookup_2017_hetoua` AS tou
ON wea.calendar_date = tou.calendar_date
AND wea.wea_dttm BETWEEN tou.tou_data_from_dttm AND tou.tou_data_to_dttm")
agg_body <- c(
"GROUP BY
wea.calendar_date,
wea.month_of_year,
wea.day_of_month,
wea.train_year,
wea.predict_year,
wea.day_of_week,
wea.week_of_year,
wea.quarter_of_year,
wea.day_of_year,
wea.day_of_year_shift,
wea.wea_data_typ_id,
wea.wea_data_typ_cd,
wea.baseline_terr_cd,
wea.opr_area_cd,
wea.wea_hr,
tou.rt_sched_cd,
tou.tou_cd")
wea <-paste(query_head, part_body, part_str, create_body, join_head, join_body, where, ") AS wea")
part_body
create_head
obj_nm
obj_nm
obj_nm
tou_body
paste(tou_body, agg_body)
agg_body
tou_body
join_body
tou_body
where <- paste(
"WHERE xref.train_year =", wea_yr,
"AND wea.wea_data_typ_id IN", wea_id,
"AND stn.wea_stn_owner =", wea_src,
") AS wea")
where
where <- paste(
"WHERE xref.train_year =", wea_yr,
"AND wea.wea_data_typ_id IN", wea_id,
"AND stn.wea_stn_owner =", wea_src,
") AS wea")
paste(where)
paste(join_body, where)
paste(from_body, join_body, where)
paste(join_head, from_body, join_body, where)
agg_head
paste(join_head, from_body, join_body, where)
agg_head
paste(creat_head, agg_head, wea)
paste(create_head, agg_head, wea)
paste(join_head, from_body, join_body, where)
wea <- paste(join_head, from_body, join_body, where)
wea
paste(tou_body, agg_body)
tou <- paste(tou_body, agg_body)
tou
paste(agg_head, wea, tou)
list(agg_head, wea, tou)
list(join_head, from_body, join_body, where)
list(tou_body, agg_body)
c(wea, tou)
tou
wea <- list(join_head, from_body, join_body, where)
tou <- list(tou_body, agg_body)
c(wea, tou)
wea
wea_tou <- c(wea, tou)
wea_tou
list(agg_head,wea, tou)
wea_tou <-
c(agg_head,wea, tou)
c(agg_head,wea, tou)
c(create_head,part_body, part_str, agg_head, wea, tou)
part_str <-  c(
"PARITION BY (day_of_year)")
part_body <- c(
"(calendar_date,
month_of_year,
day_of_month,
train_year,
predict_year,
day_of_week,
week_of_year,
quarter_of_year,
day_of_year,
day_of_year_shift,
wea_data_typ_id,
wea_data_typ_cd,
baseline_terr_cd,
opr_area_cd,
wea_hr,
rt_sched_cd,
tou_cd, meas_val)"
)
c(create_head,part_body, part_str,agg_head, wea, tou)
obj_nm <- paste0(
"`",paste("wea",wea_yr, tou, sep = "_"),"`")
create_head <- paste(
paste0("DROP TABLE IF EXISTS `rda`.`rdadata`.",obj_nm),
paste0("CREATE TABLE `rda`.`rdadata`.",obj_nm), sep = ';\n')
part_body <- c(
"(calendar_date,
month_of_year,
day_of_month,
train_year,
predict_year,
day_of_week,
week_of_year,
quarter_of_year,
day_of_year,
day_of_year_shift,
wea_data_typ_id,
wea_data_typ_cd,
baseline_terr_cd,
opr_area_cd,
wea_hr,
rt_sched_cd,
tou_cd, meas_val)"
)
part_str <-  c(
"PARITION BY (day_of_year)")
agg_head <-  c(
"AS (SELECT wea.calendar_date,
wea.month_of_year,
wea.day_of_month,
wea.train_year,
wea.predict_year,
wea.day_of_week,
wea.week_of_year,
wea.quarter_of_year,
wea.day_of_year,
wea.day_of_year_shift,
wea.wea_data_typ_id,
wea.wea_data_typ_cd,
wea.baseline_terr_cd,
wea.opr_area_cd,
wea.wea_hr,
tou.rt_sched_cd,
tou.tou_cd,
AVG(wea.meas_val) AS meas_val FROM"
)
join_head <- c(
"(SELECT
xref.calendar_date,
xref.month_of_year,
xref.day_of_month,
xref.train_year,
xref.predict_year,
xref.day_of_week,
xref.week_of_year,
xref.quarter_of_year,
xref.day_of_year,
xref.day_of_year_shift,
wea.wea_data_typ_id,
wea.wea_dt,
wea.wea_dttm,
typ.wea_data_typ_cd,
terr_xref.baseline_terr_cd,
area_xref.opr_area_cd,
DATE_PART('hour', wea.wea_dttm) AS wea_hr,
CAST(wea.meas_val AS FLOAT) meas_val"
)
from_body <- c(
"FROM `rda`.`rdadata`.`time_shift_xref` AS xref"
)
join_body <- c(
"JOIN `rda`.`rdatables`.`weather_data`  AS wea
ON xref.calendar_date = wea.wea_dt
JOIN `rda`.`rdatables`.`weather_station` AS stn
ON wea.wea_stn_cd = stn.wea_stn_cd
JOIN `rda`.`rdatables`.`weather_data_type` AS typ
ON wea.wea_data_typ_id = typ.wea_data_typ_id
INNER JOIN `rda`.`rdatables`.`weather_baseline_terr_xref` AS terr_xref
ON wea.wea_stn_cd = terr_xref.wea_stn_cd
AND xref.month_of_year = terr_xref.mo_id
JOIN `rda`.`rdatables`.`weather_op_area_xref` AS area_xref
ON terr_xref.wea_stn_cd = area_xref.wea_stn_cd"
)
where <- paste(
"WHERE xref.train_year =", wea_yr,
"AND wea.wea_data_typ_id IN", wea_id,
"AND stn.wea_stn_owner =", wea_src,
") AS wea")
tou_body <- c(
"JOIN `rda`.`rdadata`.`tou_lookup_2017_hetoua` AS tou
ON wea.calendar_date = tou.calendar_date
AND wea.wea_dttm BETWEEN tou.tou_data_from_dttm AND tou.tou_data_to_dttm")
agg_body <- c(
"GROUP BY
wea.calendar_date,
wea.month_of_year,
wea.day_of_month,
wea.train_year,
wea.predict_year,
wea.day_of_week,
wea.week_of_year,
wea.quarter_of_year,
wea.day_of_year,
wea.day_of_year_shift,
wea.wea_data_typ_id,
wea.wea_data_typ_cd,
wea.baseline_terr_cd,
wea.opr_area_cd,
wea.wea_hr,
tou.rt_sched_cd,
tou.tou_cd")
c(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
create_head
wea_yr = 2017
tou = "hetoua"
wea_id = "(1, 22, 23)"
wea_src = "PGE"
train = TRUE
wea_yr
obj_nm <- paste0(
"`",paste("wea",wea_yr, tou, sep = "_"),"`")
create_head <- paste(
paste0("DROP TABLE IF EXISTS `rda`.`rdadata`.",obj_nm),
paste0("CREATE TABLE `rda`.`rdadata`.",obj_nm), sep = ';\n')
part_body <- c(
"(calendar_date,
month_of_year,
day_of_month,
train_year,
predict_year,
day_of_week,
week_of_year,
quarter_of_year,
day_of_year,
day_of_year_shift,
wea_data_typ_id,
wea_data_typ_cd,
baseline_terr_cd,
opr_area_cd,
wea_hr,
rt_sched_cd,
tou_cd, meas_val)"
)
part_str <-  c(
"PARITION BY (day_of_year)")
agg_head <-  c(
"AS (SELECT wea.calendar_date,
wea.month_of_year,
wea.day_of_month,
wea.train_year,
wea.predict_year,
wea.day_of_week,
wea.week_of_year,
wea.quarter_of_year,
wea.day_of_year,
wea.day_of_year_shift,
wea.wea_data_typ_id,
wea.wea_data_typ_cd,
wea.baseline_terr_cd,
wea.opr_area_cd,
wea.wea_hr,
tou.rt_sched_cd,
tou.tou_cd,
AVG(wea.meas_val) AS meas_val FROM"
)
join_head <- c(
"(SELECT
xref.calendar_date,
xref.month_of_year,
xref.day_of_month,
xref.train_year,
xref.predict_year,
xref.day_of_week,
xref.week_of_year,
xref.quarter_of_year,
xref.day_of_year,
xref.day_of_year_shift,
wea.wea_data_typ_id,
wea.wea_dt,
wea.wea_dttm,
typ.wea_data_typ_cd,
terr_xref.baseline_terr_cd,
area_xref.opr_area_cd,
DATE_PART('hour', wea.wea_dttm) AS wea_hr,
CAST(wea.meas_val AS FLOAT) meas_val"
)
from_body <- c(
"FROM `rda`.`rdadata`.`time_shift_xref` AS xref"
)
join_body <- c(
"JOIN `rda`.`rdatables`.`weather_data`  AS wea
ON xref.calendar_date = wea.wea_dt
JOIN `rda`.`rdatables`.`weather_station` AS stn
ON wea.wea_stn_cd = stn.wea_stn_cd
JOIN `rda`.`rdatables`.`weather_data_type` AS typ
ON wea.wea_data_typ_id = typ.wea_data_typ_id
INNER JOIN `rda`.`rdatables`.`weather_baseline_terr_xref` AS terr_xref
ON wea.wea_stn_cd = terr_xref.wea_stn_cd
AND xref.month_of_year = terr_xref.mo_id
JOIN `rda`.`rdatables`.`weather_op_area_xref` AS area_xref
ON terr_xref.wea_stn_cd = area_xref.wea_stn_cd"
)
where <- paste(
"WHERE xref.train_year =", wea_yr,
"AND wea.wea_data_typ_id IN", wea_id,
"AND stn.wea_stn_owner =", wea_src,
") AS wea")
tou_body <- c(
"JOIN `rda`.`rdadata`.`tou_lookup_2017_hetoua` AS tou
ON wea.calendar_date = tou.calendar_date
AND wea.wea_dttm BETWEEN tou.tou_data_from_dttm AND tou.tou_data_to_dttm")
agg_body <- c(
"GROUP BY
wea.calendar_date,
wea.month_of_year,
wea.day_of_month,
wea.train_year,
wea.predict_year,
wea.day_of_week,
wea.week_of_year,
wea.quarter_of_year,
wea.day_of_year,
wea.day_of_year_shift,
wea.wea_data_typ_id,
wea.wea_data_typ_cd,
wea.baseline_terr_cd,
wea.opr_area_cd,
wea.wea_hr,
tou.rt_sched_cd,
tou.tou_cd")
c(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
wea_tou <- c(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
wea_tou_query <- c(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
wea_tou_query
list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
wea_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
source('~/Documents/dstrain/R/clean_query.R', echo=TRUE)
wea_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
wea_tou_query
wea_tou_query[1]
wea_tou_query[[1]]
wea_tou_query[[1]] %>% clean_query()
stringr::str_replace_all(string = part_body, pattern = '[\n\r]', replacement = ' ')
stringr::str_replace_all(string = part_body, pattern = '[\n\r]', replacement = '')
stringr::str_replace_all(string = part_body, pattern = '[\n]', replacement = '')
wea_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
wea_tou_query
wea_tou_query
readr::write_file(x = wea_tou_query, path = 'data/query.sql')
wea_tou_query
unlist(wea_tou_query)
unlist(unlist(wea_tou_query))
readr::write_file(x = unlist(wea_tou_query), path = 'data/query.sql')
stringr::str_replace_all(string = wea_tou_query, pattern = '[\n]', replacement = '')
stringr::str_replace_all(string = wea_tou_query, pattern = '[\n]', replacement = ' ')
wea_tou_query
readr::write_file(x = wea_tou_query[7], path = 'data/query.sql')
readr::write_file(x = wea_tou_query[[7]], path = 'data/query.sql')
wea_tou_query <- c(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
wea_tou_query
readr::write_file(x = wea_tou_query[[7]], path = 'data/query.sql')
readr::write_file(x = wea_tou_query[[7:9]], path = 'data/query.sql')
str(wea_tou_query)
wea_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
str(wea_tou_query)
?rind
?rbind
rbind(wea_tou_query)
wea_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
rbind(wea_tou_query)
wea_tou_query <- c(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
rbind(wea_tou_query)
rbind(wea_tou_query, deparse.level = 1)
rbind.data.frame(wea_tou_query)
wea_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
rbind.data.frame(wea_tou_query)
rbind(wea_tou_query)
wea_tou_query <- list(create_head,part_body, part_str,agg_head, join_head, from_body, join_body, where, tou_body)
wea_tou_query
res <- numeric(length = length(a))
a <- 1:10
b <- 1:10
res <- numeric(length = length(a))
res
for (i in seq_along(a)) {
res[i] <- a[i] + b[i]
}
seq_along(wea_tou_query)
for (i in seq_along(wea_tou_query)) {
readr::write_file(wea_tou_query[i], path = 'data/00_query.sql', append = TRUE)
}
wea_tou_query[i]
i
for (i in seq_along(wea_tou_query)) {
readr::write_file(x = wea_tou_query[i], path = 'data/00_query.sql', append = TRUE)
}
lapply(wea_tou_query, function(x){length(x)})
lapply(wea_tou_query, function(x){nchar(x)})
lapply(wea_tou_query, function(x){readr::write_file(x = x, path = path = 'data/query.sql'))})
lapply(wea_tou_query, function(x){readr::write_file(x = x, path = 'data/query.sql'))})
lapply(wea_tou_query, function(x) {
readr::write_file(x = x, path = 'data/query.sql'))
})
lapply(wea_tou_query, function(x) {
readr::write_file(x = x, path = 'data/query.sql')
})
lapply(wea_tou_query, function(x) {readr::write_file(x = x, path = 'data/query.sql')})
